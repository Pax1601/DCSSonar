<!doctype html>
<html>
  <head>
    <script src="pixi.js"></script>
    <script src="CRT.js"></script>
    <script src="knob.js"></script>
    <script src="button.js"></script>
    <style>
      body{
          margin-top: 0px; 
          margin-bottom: 0px; 
          margin-left: 0px; 
          margin-right: 0px;
          padding: 0;
          color: black; 
          font-size: 10pt; 
      }
    </style>
  </head>
  <body>
    <script>
      // Create the application helper and add its render target to the page
      const app = new PIXI.Application({
          autoResize: true,
          resolution: devicePixelRatio 
      });
      document.body.appendChild(app.view);
      
      // Listen for window resize events
      window.addEventListener('resize', resize);
      window.onwheel = captureWheel;
      window.onclick = captureClick;

      // PARAMETERS
      //range_rings = 5
      //persistency = 256
      //render_interval = 2
      //base_noise_level = 0.5
      //base_noise_density = 512
      //max_range = 10

      //contacts = [[7.5, 0, 8], [2.6, 90, 9], [3.6, 123, 12], [8.6, 283, 7], [4.6, 183, 4], [9.1, 150, 7], [8.6, 45, 7]]
//

      let crt = new CRT(app);

      let sprite = PIXI.Sprite.from('sonar.png');
      app.stage.addChild(sprite);

      let cursorIntesityKnob  = new RotationKnob(app, crt.setCursorIntensity.bind(crt), "knobs/cursor_intensity.png", 147 / 1024, 120 / 1024, 60 / 1024, 10, 0, 360, 180);
      let crtIntesityKnob     = new RotationKnob(app, crt.setCrtIntensity.bind(crt), "knobs/crt_intensity.png", 145 / 1024, 251 / 1024, 60 / 1024, 10, 0, 360, 180);
      let videoGainKnob       = new RotationKnob(app, crt.setVideoGain.bind(crt), "knobs/video_gain.png", 151 / 1024, 373 / 1024, 60 / 1024, 10, 0, 360, 180);
      let audioGainKnob       = new RotationKnob(app, crt.setAudioGain.bind(crt), "knobs/audio_gain.png", 151 / 1024, 500 / 1024, 60 / 1024, 10, 0, 360, 180);
      let cursorPositionKnob  = new RotationKnob(app, crt.setCursorPosition.bind(crt), "knobs/cursor_position.png", 787 / 1024, 785 / 1024, 252 / 1024, 1, -Infinity, Infinity);
      let mtiThresholdKnob    = new PositionKnob(app, crt.setMtiThreshold.bind(crt), "knobs/position_knob.png", 811 / 1024, 507 / 1024, 130 / 1024, [-50, -20, 20, 50]);
      let rangeScaleKnob      = new PositionKnob(app, crt.setRange.bind(crt), "knobs/position_knob.png", 202 / 1024, 854 / 1024, 130 / 1024, [-75, -45, -15, 15, 45, 75]);
      let frequencyKnob       = new PositionKnob(app, crt.setFrequency.bind(crt), "knobs/position_knob.png", 380 / 1024, 854 / 1024, 130 / 1024, [-45, -15, 15, 45]);
      let modeKnob            = new PositionKnob(app, crt.setMode.bind(crt), "knobs/position_knob.png", 565 / 1024, 854 / 1024, 130 / 1024, [-45, -15, 15, 45]);
      
      let powerButton         = new StateButton(app, crt.setState.bind(crt), ["buttons/powerOFF.png", "buttons/powerON.png"], 865 / 1024, 197 / 1024, 63 / 1024, 48 / 1024);
      
      // Listen for animate update
      let renderTimer = 0;
      app.ticker.add((delta) => {
        size = Math.min(window.innerWidth, window.innerHeight)
        renderTimer += (1 / 60) * delta;

        crt.update(size);

        crt.drawBackground();
        crt.drawAngles();

        cursorIntesityKnob.update(size);
        crtIntesityKnob.update(size);
        videoGainKnob.update(size);
        audioGainKnob.update(size);
        cursorPositionKnob.update(size);

        mtiThresholdKnob.update(size);
        rangeScaleKnob.update(size); 
        frequencyKnob.update(size);   
        modeKnob.update(size);    
        
        powerButton.update(size);

        if (renderTimer > crt.getPingInterval())
        {
          renderTimer = 0;
        }

        crt.drawReturns(renderTimer);

        crt.fadeReturns();
      });

      resize();

      function resize() {
          size = Math.min(window.innerWidth, window.innerHeight)
          app.renderer.resize(size, size);
          sprite.width = size;
          sprite.height = size;
      }

      function captureWheel(event) {
        Knob.allInstances.forEach(knob => knob.wheelEvent(event));
      }

      function captureClick(event) {
        Button.allInstances.forEach(button => button.clickEvent(event));
      }
    </script>
  </body>
</html>